<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Kerr County USGS – Current + Today Stats (IV 00060) & NWS Flood Stages + Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
  :root { --muted:#666; --border:#ddd; }
  body { font: 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
  h1 { margin: 0 0 .25rem; }
  h2 { margin: 1.5rem 0 .5rem; }
  .muted { color: var(--muted); }
  .row { display: flex; gap: .5rem; align-items: center; margin: .75rem 0; flex-wrap: wrap; }
  button { padding: .5rem .9rem; border-radius: .5rem; border: 1px solid #ccc; cursor: pointer; }
  input[type="text"] { width: 520px; max-width: 100%; padding: .45rem .6rem; border: 1px solid #ccc; border-radius: .4rem; }
  input[type="number"] { padding: .35rem .5rem; border: 1px solid #ccc; border-radius: .4rem; }
  table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  th, td { border: 1px solid var(--border); padding: .5rem; text-align: left; vertical-align: top; }
  th { background: #f6f6f6; }
  .right { text-align: right; }
  .divider { margin: 1.5rem 0; border: 0; height: 1px; background: #e5e5e5; }
  .pill { display:inline-block; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:12px; }
  .stage-None    { background:#f3f3f3; }
  .stage-Action  { background:#eaf2ff; }
  .stage-Minor   { background:#fff5e6; }
  .stage-Moderate{ background:#ffeaea; }
  .stage-Major   { background:#ffe1e1; }
  details summary { cursor:pointer; margin:.5rem 0; }
  code { background:#f7f7f7; padding:.1rem .25rem; border-radius:.25rem; }

  /* Map */
  #mapWrap { margin-top: 1.5rem; }
  #mapTitle { margin: .25rem 0; }
  #map { height: 600px; width: 100%; border: 1px solid #ddd; border-radius: 8px; }
  .legend { background: white; padding: .5rem .75rem; border: 1px solid #ccc; border-radius: 8px; line-height: 1.2; }
  .legend .dot { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:.5rem; vertical-align:middle; }

  /* Matrix section */
  #matrixControls button { margin-right: .4rem; }
  #tbl-matrix th { white-space: nowrap; }
  #tbl-matrix td.right { text-align: right; }

  /* Brighter, haloed gauge markers */
  .gauge-dot{
    --color:#777;
    width: 18px; height: 18px; border-radius: 50%;
    background: var(--color);
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px rgba(0,0,0,.25);
  }

  /* Title bar */
  .titlebar{
    --ring:#c7d2fe; --bg1:#0b1220; --bg2:#111827; --text:#e5e7eb;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    border:1px solid #1f2937; border-radius:14px; padding:1rem 1.25rem; margin:1rem 0 1.25rem;
    box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 12px 28px rgba(0,0,0,.25); color:var(--text);
  }
  .tb-top{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
  .tb-brand{ display:flex; align-items:center; gap:.6rem; }
  .tb-logo{ width:28px; height:28px; fill:#60a5fa; filter: drop-shadow(0 1px 0 rgba(255,255,255,.6)); }
  .tb-title{ font-weight:800; margin:0; letter-spacing:.1px; }

  .tb-badges{ display:flex; gap:.5rem; flex-wrap:wrap; }
  .tb-badge{ display:inline-block; padding:.25rem .55rem; border-radius:999px; background:#111827; border:1px solid #374151; color:#e5e7eb; font-size:.85rem; }

  .chips-row{ margin-top:.45rem; display:flex; align-items:center; gap:.45rem; flex-wrap:wrap; }
  .tb-label{ font-weight:700; color:#cbd5e1; margin-right:.1rem; }
  .chip{ display:inline-block; padding:.2rem .55rem; border-radius:999px; font-weight:600; font-size:.85rem; border:1px solid transparent; }
  .chip-county{ background:#dbeafe; color:#1e3a8a; border-color:#93c5fd; }
  .chip-city{   background:#dcfce7; color:#065f46; border-color:#86efac; }
  /* Light pulse for the "Copy (no header)" river-flow button */
#copyMatrixNoHeaderBtn{
  position: relative;
  overflow: visible; /* allow the glow to show outside the button */
  background-color:#0044ff;
  color:white;
}
#copyMatrixNoHeaderBtn:hover{
    background-color:#4274ff;
}
#copyMatrixNoHeaderBtn::after{
  content:"";
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:120%; height:150%;
  border-radius:999px;
  box-shadow:0 0 0 0 rgb(0, 13, 255); /* light blue */
  animation:lightPulse 1.8s ease-out infinite;
  pointer-events:none;
}

@keyframes lightPulse{
  0%   { box-shadow:0 0 0 0   rgba(96,165,250,.35); }
  70%  { box-shadow:0 0 0 18px rgba(96,165,250,0); }
  100% { box-shadow:0 0 0 0   rgba(96,165,250,0); }
}

/* Respect disabled + reduced-motion */
#copyMatrixNoHeaderBtn:disabled::after{ animation:none; box-shadow:none; }
@media (prefers-reduced-motion: reduce){
  #copyMatrixNoHeaderBtn::after{ animation:none; }
}
</style>

<body>
  <!-- Title -->
  <header class="titlebar">
    <div class="tb-top">
      <div class="tb-brand">
        <svg class="tb-logo" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2S5 10 5 14.5C5 18.09 8.134 21 12 21s7-2.91 7-6.5C19 10 12 2 12 2z"/></svg>
        <h1 class="tb-title">Kerr County | River Flow (CFS) per USGS River Flow Dashboard</h1>
      </div>
      <div class="tb-badges">
        <span class="tb-badge" id="titleUpdated">Updated —</span>
      </div>
    </div>
  </header>

  <!-- DAILY FLOW MATRIX -->
  <hr class="divider" />
  <p class="muted">Each fetch stores today’s snapshot (Current CFS) once per day. Use the buttons to copy/download. Data is kept in your browser (localStorage).</p>
  <div id="matrixControls" class="row">
    <button id="copyMatrixBtn" disabled>Copy River Flows</button>
    <button id="copyMatrixNoHeaderBtn" title="Copy the latest day's row only (no header)" disabled>Copy (no header)</button>
    <button id="csvMatrixBtn"  disabled>Download River Flows CSV</button>
    <button id="clearMatrixBtn">Clear River Flows</button>    <button id="fetchBtn">Fetch now</button>
  </div>

  <table id="tbl-matrix" hidden>
    <thead><tr id="matrixHeadRow"></tr></thead>
    <tbody id="matrixBody"></tbody>
  </table>


  <!-- <p class="muted">
    Uses the USGS Instantaneous Values API to fetch the last 24 hours of discharge (<code>00060</code>, cfs),
    shows the latest reading and min/max/avg since <strong>12:00 AM America/Chicago</strong>.
  </p> -->

  <!-- MAP -->
  <hr class="divider" />
  <div id="mapWrap">
    <h2 id="mapTitle">Map of Gauges (colored by flood category)</h2>
    <div id="map" aria-label="Leaflet map of USGS gauges"></div>
  </div>
  <h2>Kerr County – USGS Current Flow with Today’s Min/Max/Avg</h2>
  <div class="row">
    <!-- <button id="fetchBtn">Fetch now</button> -->
    <button id="csvBtn" disabled>Download CSV</button>
    <button style="background-color:green;color:white;" id="copyUsgsBtn" disabled>Copy USGS table</button>
    <button style="background-color:steelblue;color:white;"  id="copyNwsBtn" disabled>Copy NWS table</button>
    <label class="muted">Auto-refresh (min):
      <input type="number" id="autoMin" value="0" min="0" style="width:4ch">
    </label>
    <span id="status" class="muted"></span>
  </div>

  <div class="row">
    <label class="muted">Sites (comma-separated IDs):</label>
    <input id="sitesInput" type="text"
      value="08165300,08165500,08166000,08166140,08166200,08166250,08167000"
      title="Edit and click Fetch now" />
  </div>

  <table id="tbl-usgs" hidden>
    <thead>
      <tr>
        <th>Site ID</th><th>Site Name</th><th>Timestamp (UTC)</th>
        <th class="right">Current (cfs)</th><th class="right">Today Min</th>
        <th class="right">Today Max</th><th class="right">Today Avg</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr class="divider" />
  <h2>NWS/NWPS Flood-Stage Context (separate from USGS)</h2>
  <p class="muted">
    <strong>USGS</strong> provides observations (e.g., discharge <code>00060</code> in cfs; gage height <code>00065</code> in ft).<br/>
    <strong>NWS/NWPS</strong> defines flood categories (Action, Minor, Moderate, Major) at many river points based on
    <em>gage height (ft)</em> thresholds.
  </p>

  <details>
    <summary><strong>Thresholds mapping</strong> (Action / Minor / Moderate / Major, in feet)</summary>
    <pre id="mappingView" style="white-space:pre-wrap; background:#fafafa; padding:.75rem; border:1px solid #eee; border-radius:.5rem;"></pre>
  </details>

  <table id="tbl-nws" hidden>
    <thead>
      <tr>
        <th>Site ID</th><th>Site Name</th><th class="right">Gage Height (ft)</th>
        <th>Action</th><th>Minor</th><th>Moderate</th><th>Major</th><th>Category</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
/* ================== Config ================== */
const PARAM_FLOW  = '00060'; // discharge (cfs)
const PARAM_STAGE = '00065'; // gage height (ft)
const BASE  = 'https://waterservices.usgs.gov/nwis/iv/';
const CHI_TZ = 'America/Chicago';

/* NWS thresholds (fill real ones as needed) */
const NWS_THRESHOLDS = {
  "08165300": { },
  "08165500": { action: 10, minor: 10, moderate: 12, major: 22 },
  "08166000": { },  // Johnson Ck nr Ingram
  "08166140": { },
  "08166200": { action: 7,  minor: 9,  moderate: 12, major: 20 },
  "08166250": { },
  "08167000": { action: 10, minor: 21, moderate: 26, major: 28 }
};
const FRIENDLY_NAME = {}; // optional overrides

/* ================== Utilities ================== */
const chicagoDateFmt = new Intl.DateTimeFormat('en-CA',{timeZone:CHI_TZ,year:'numeric',month:'2-digit',day:'2-digit'});
function chicagoYmd(d){ return chicagoDateFmt.format(d); }
function parseSites(input){ return input.split(',').map(s=>s.trim()).filter(Boolean); }
function toCSV(rows, header){
  const esc = (s)=>`"${String(s ?? '').replace(/"/g,'""')}"`;
  const arr = header? [header, ...rows] : rows;
  return arr.map(r => r.map(esc).join(',')).join('\r\n');
}
function tableToTSV(tableId){
  const table=document.getElementById(tableId); if(!table||table.hidden) return '';
  const rows=[]; const head=[...(table.tHead?.rows?.[0]?.cells||[])].map(th=>th.textContent.trim());
  if(head.length) rows.push(head);
  [...table.tBodies[0].rows].forEach(tr=>{
    rows.push([...tr.cells].map(td=>td.textContent.trim()));
  });
  return rows.map(r=>r.join('\t')).join('\r\n');
}
async function copyTable(tableId,label){
  try{ const t=tableToTSV(tableId); if(!t) throw new Error('No rows to copy.');
    await navigator.clipboard.writeText(t); flashStatus(`Copied ${label} to clipboard.`);
  }catch(e){ flashStatus(`Copy failed: ${e.message}`); }
}
function flashStatus(msg){ const el=document.getElementById('status'); const p=el.textContent; el.textContent=msg; setTimeout(()=>{el.textContent=p;},2000); }
function latestValue(series){
  const vals=series?.values?.[0]?.value||[]; if(!vals.length) return null;
  const last=vals[vals.length-1]; const v=last?.value; if(v===''||v===undefined) return null;
  return { when:last.dateTime, value:Number(v) };
}
function seriesParam(s){ return s?.variable?.variableCode?.[0]?.value || ''; }
function seriesSiteId(s){ return s?.sourceInfo?.siteCode?.[0]?.value || ''; }
function seriesSiteName(s){ return s?.sourceInfo?.siteName || ''; }
function seriesLatLng(s){
  const g=s?.sourceInfo?.geoLocation?.geogLocation; const lat=g?.latitude, lon=g?.longitude;
  return (typeof lat==='number' && typeof lon==='number') ? [lat,lon] : null;
}
function statsTodayFromSeries(series, todayChiYmd){
  const vals=series?.values?.[0]?.value||[]; let sum=0,count=0,min=Infinity,max=-Infinity;
  for(const rec of vals){ const v=rec?.value; if(v===''||v===undefined) continue;
    const ymd=chicagoYmd(new Date(rec.dateTime)); if(ymd!==todayChiYmd) continue;
    const num=Number(v); if(Number.isNaN(num)) continue;
    sum+=num; count++; if(num<min)min=num; if(num>max)max=num;
  }
  if(!count) return {min:null,max:null,avg:null};
  return {min,max,avg:sum/count};
}
function categorizeStage(heightFt,t){
  if(heightFt==null||t==null) return {label:'—', css:'stage-None', color:'#777'};
  if(t.major    !=null && heightFt>=t.major)    return {label:'Major',    css:'stage-Major',    color:'#b30000'};
  if(t.moderate !=null && heightFt>=t.moderate) return {label:'Moderate', css:'stage-Moderate', color:'#ff4d4d'};
  if(t.minor    !=null && heightFt>=t.minor)    return {label:'Minor',    css:'stage-Minor',    color:'#ff9900'};
  if(t.action   !=null && heightFt>=t.action)   return {label:'Action',   css:'stage-Action',   color:'#2b7bff'};
  return {label:'No Flood', css:'stage-None', color:'#777'};
}
function fmtNum(v,d=3){ return (v==null||Number.isNaN(v)) ? '—' : Number(v).toLocaleString(undefined,{maximumFractionDigits:d}); }

/* ================== Rendering (tables) ================== */
function renderUsgsTable(rows){
  const tb=document.querySelector('#tbl-usgs tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    [r.siteId,r.siteName,r.when,
     r.flowCurrent!=null? r.flowCurrent.toLocaleString(undefined,{maximumFractionDigits:3}):'',
     r.flowMinToday!=null? r.flowMinToday.toLocaleString(undefined,{maximumFractionDigits:3}):'',
     r.flowMaxToday!=null? r.flowMaxToday.toLocaleString(undefined,{maximumFractionDigits:3}):'',
     r.flowAvgToday!=null? r.flowAvgToday.toLocaleString(undefined,{maximumFractionDigits:3}):'',
    ].forEach((c,i)=>{ const td=document.createElement('td'); td.textContent=c; if(i>=3) td.className='right'; tr.appendChild(td); });
    tb.appendChild(tr);
  });
  const show=rows.length>0;
  document.getElementById('tbl-usgs').hidden=!show;
  document.getElementById('copyUsgsBtn').disabled=!show;
}
function renderNwsTable(rows){
  const tb=document.querySelector('#tbl-nws tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr'); const t=r.thresholds||{}; const cat=r.category||{label:'—',css:'stage-None'};
    const cells=[r.siteId,r.siteName,
      r.stageCurrent!=null? r.stageCurrent.toLocaleString(undefined,{maximumFractionDigits:2}):'',
      t.action??'', t.minor??'', t.moderate??'', t.major??'', {badge:cat.label, css:cat.css}
    ];
    cells.forEach((c,i)=>{ const td=document.createElement('td');
      if(typeof c==='object' && c.badge){ const span=document.createElement('span'); span.className=`pill ${c.css}`; span.textContent=c.badge; td.appendChild(span); }
      else { td.textContent=c; if(i===2) td.className='right'; }
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
  const show=rows.length>0;
  document.getElementById('tbl-nws').hidden=!show;
  document.getElementById('copyNwsBtn').disabled=!show;
  document.getElementById('mappingView').textContent = JSON.stringify(NWS_THRESHOLDS,null,2);
}

/* ================== Map ================== */
let map, gaugeLayer;
window.__siteLatLng=new Map();
function ensureMap(){
  if(map) return;
  map=L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  gaugeLayer=L.layerGroup().addTo(map);

  const legend=L.control({position:'bottomright'});
  legend.onAdd=function(){
    const div=L.DomUtil.create('div','legend');
    div.innerHTML=`
      <div><strong>Flood Category</strong></div>
      <div><span class="dot" style="background:#777"></span>No Flood</div>
      <div><span class="dot" style="background:#2b7bff"></span>Action</div>
      <div><span class="dot" style="background:#ff9900"></span>Minor</div>
      <div><span class="dot" style="background:#ff4d4d"></span>Moderate</div>
      <div><span class="dot" style="background:#b30000"></span>Major</div>`;
    return div;
  }; legend.addTo(map);
}
function updateMap(mapRows){
  ensureMap(); gaugeLayer.clearLayers();
  const pts=[];
  mapRows.forEach(r=>{
    if(!r.latLng) return;
    const icon=L.divIcon({
      className:'gaugeIcon',
      html:`<div class="gauge-dot" style="--color:${r.category?.color||'#777'}"></div>`,
      iconSize:[18,18], iconAnchor:[9,9], popupAnchor:[0,-12]
    });
    const m=L.marker(r.latLng,{icon});
    m.bindPopup(`
      <div style="min-width:220px">
        <strong>${r.siteId}</strong><br/>${r.siteName}<br/>
        <small>${new Date(r.when).toLocaleString()}</small>
        <hr style="border:none;border-top:1px solid #eee;margin:.35rem 0"/>
        <div><b>Current</b>: ${fmtNum(r.flowCurrent)} cfs</div>
        <div><b>Today Min</b>: ${fmtNum(r.flowMinToday)} cfs</div>
        <div><b>Today Max</b>: ${fmtNum(r.flowMaxToday)} cfs</div>
        <div><b>Today Avg</b>: ${fmtNum(r.flowAvgToday)} cfs</div>
        <div style="margin-top:.25rem"><b>Stage</b>: ${fmtNum(r.stageCurrent,2)} ft</div>
        <div><b>Category</b>: <span class="pill ${r.category?.css||'stage-None'}">${r.category?.label||'—'}</span></div>
      </div>`).addTo(gaugeLayer);
    pts.push(r.latLng);
  });
  if(pts.length){ map.fitBounds(L.latLngBounds(pts).pad(0.2)); } else { map.setView([30.05,-99.14],10); }
}

/* ================== Fetch & build ================== */
async function fetchUSGS(sites){
  const url = `${BASE}?format=json&sites=${encodeURIComponent(sites.join(','))}` +
              `&parameterCd=${PARAM_FLOW},${PARAM_STAGE}&siteStatus=all&period=P1D`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(`USGS IV error ${res.status}`); return res.json();
}
function buildPerSiteData(json){
  const seriesArr=json?.value?.timeSeries||[]; const sites=new Map();
  for(const s of seriesArr){
    const id=seriesSiteId(s), name=seriesSiteName(s), param=seriesParam(s), latLng=seriesLatLng(s);
    if(!id||!param) continue;
    if(!sites.has(id)) sites.set(id,{siteId:id, siteName:name, flow:null, stage:null, latLng});
    const e=sites.get(id);
    if(param===PARAM_FLOW) e.flow=s;
    if(param===PARAM_STAGE) e.stage=s;
    if(!e.latLng && latLng) e.latLng=latLng;
  }
  const usgsRows=[], nwsRows=[], mapRows=[];
  for(const [,e] of sites){
    const siteId=e.siteId, siteName=e.siteName;
    // flow
    let flowCurrent=null, flowMinToday=null, flowMaxToday=null, flowAvgToday=null, when='';
    if(e.flow){ const latest=latestValue(e.flow); const stats=statsTodayFromSeries(e.flow,chicagoYmd(new Date()));
      flowCurrent=latest?.value ?? null; when=latest?.when ?? '';
      flowMinToday=stats.min; flowMaxToday=stats.max; flowAvgToday=stats.avg; }
    usgsRows.push({siteId,siteName,when,flowCurrent,flowMinToday,flowMaxToday,flowAvgToday});
    // stage/category
    let stageCurrent=null; if(e.stage){ const s=latestValue(e.stage); stageCurrent=s?.value ?? null; }
    const thresholds=NWS_THRESHOLDS[siteId]||null; const category=categorizeStage(stageCurrent,thresholds);
    nwsRows.push({siteId,siteName,stageCurrent,thresholds,category});
    mapRows.push({siteId,siteName,when,flowCurrent,flowMinToday,flowMaxToday,flowAvgToday,stageCurrent,category,latLng:e.latLng});
  }
  // Keep input order for USGS/NWS/map tables
  const order=parseSites(document.getElementById('sitesInput').value);
  const byOrder=(a,b)=>order.indexOf(a.siteId)-order.indexOf(b.siteId);
  usgsRows.sort(byOrder); nwsRows.sort(byOrder); mapRows.sort(byOrder);
  return { usgsRows, nwsRows, mapRows };
}

let autoTimer=null;
async function doFetch(){
  try{
    const sites=parseSites(document.getElementById('sitesInput').value); if(!sites.length) throw new Error('Enter at least one site id.');
    document.getElementById('status').textContent='Fetching...';
    const json=await fetchUSGS(sites);
    const { usgsRows, nwsRows, mapRows } = buildPerSiteData(json);

    renderUsgsTable(usgsRows);
    renderNwsTable(nwsRows);
    updateMap(mapRows);

    // remember site coords
    window.__siteLatLng.clear(); mapRows.forEach(r=>{ if(r.latLng) window.__siteLatLng.set(r.siteId,r.latLng); });

    // CSV payload for USGS
    window.__rows = usgsRows.map(r => [r.when,r.siteId,r.siteName,r.flowCurrent,
                                       r.flowMinToday??'',r.flowMaxToday??'',r.flowAvgToday??'']);

    // Update title badge
    updateTitleBar();

    // update matrix
    updateDailyMatrix(usgsRows);

    document.getElementById('csvBtn').disabled = !window.__rows.length;
    document.getElementById('status').textContent = `${usgsRows.length} sites • updated ${new Date().toISOString()}`;
  }catch(e){
    document.getElementById('csvBtn').disabled=true;
    document.getElementById('tbl-usgs').hidden=true;
    document.getElementById('tbl-nws').hidden=true;
    document.getElementById('copyUsgsBtn').disabled=true;
    document.getElementById('copyNwsBtn').disabled=true;
    document.getElementById('status').textContent=e.message;
  }
}
document.getElementById('fetchBtn').onclick=doFetch;
document.getElementById('csvBtn').onclick=()=>{
  const csv=toCSV(window.__rows||[],["timestamp_iso","site_id","site_name","current_cfs","todays_min_cfs","todays_max_cfs","todays_avg_cfs"]);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`kerr_usgs_current_flow_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};
document.getElementById('copyUsgsBtn').onclick=()=>copyTable('tbl-usgs','USGS table');
document.getElementById('copyNwsBtn').onclick =()=>copyTable('tbl-nws','NWS table');
document.getElementById('autoMin').addEventListener('change', ()=>{
  const mins=Number(document.getElementById('autoMin').value||0);
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  if(mins>0){ autoTimer=setInterval(doFetch, Math.max(mins,1)*60*1000); }
});

/* ================== Daily Flow Matrix (persisted) ================== */
const MATRIX_KEY='kerr-daily-matrix-v1';
function loadMatrix(){ try{return JSON.parse(localStorage.getItem(MATRIX_KEY))||{cols:[],rows:[]}}catch{return {cols:[],rows:[]}} }
function saveMatrix(m){ localStorage.setItem(MATRIX_KEY, JSON.stringify(m)); }
function labelFor(siteId, siteName){ return FRIENDLY_NAME[siteId] || siteName || siteId; }

function updateDailyMatrix(usgsRows){
  const m=loadMatrix(); const today=chicagoYmd(new Date());
  const desiredCols=usgsRows.map(r=>({id:r.siteId, label:labelFor(r.siteId,r.siteName)}));
  m.cols=desiredCols;
  let row=m.rows.find(r=>r.date===today); if(!row){ row={date:today, values:{}}; m.rows.push(row); }
  for(const r of usgsRows){ const val=(r.flowCurrent==null||Number.isNaN(r.flowCurrent))? null : Number(r.flowCurrent); row.values[r.siteId]=val; }
  m.rows.sort((a,b)=>a.date.localeCompare(b.date));
  saveMatrix(m); renderMatrix();
}
function renderMatrix(){
  const m=loadMatrix(); const table=document.getElementById('tbl-matrix'); const head=document.getElementById('matrixHeadRow'); const body=document.getElementById('matrixBody');
  head.innerHTML=''; body.innerHTML='';
  if(!m.cols.length){ table.hidden=true; document.getElementById('copyMatrixBtn').disabled=true; document.getElementById('csvMatrixBtn').disabled=true; return; }
  const thDate=document.createElement('th'); thDate.textContent='Date'; head.appendChild(thDate);
  m.cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; head.appendChild(th); });
  for(const r of m.rows){
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.textContent=r.date; tr.appendChild(tdDate);
    m.cols.forEach(c=>{ const v=r.values?.[c.id]; const td=document.createElement('td'); td.className='right'; td.textContent=(v==null?'':Number(v).toLocaleString(undefined,{maximumFractionDigits:1})); tr.appendChild(td); });
    body.appendChild(tr);
  }
  table.hidden=false;
  document.getElementById('copyMatrixBtn').disabled=m.rows.length===0;
  document.getElementById('copyMatrixNoHeaderBtn').disabled=m.rows.length===0;
  document.getElementById('csvMatrixBtn').disabled=m.rows.length===0;
  highlightCopyNoHeader();
}
document.getElementById('copyMatrixBtn').onclick=()=>copyTable('tbl-matrix','Daily Flow Matrix');
document.getElementById('copyMatrixNoHeaderBtn').onclick=async()=>{
  const m=loadMatrix(); if(!m.rows||m.rows.length===0) return;
  const last=m.rows[m.rows.length-1]; const row=[last.date, ...m.cols.map(c=>last.values?.[c.id]??'')];
  const tsv=row.map(v=>String(v??'')).join('\t');
  try{ await navigator.clipboard.writeText(tsv); flashStatus('Copied latest row (no header).'); }catch(e){ flashStatus('Copy failed: '+e.message); }
};
document.getElementById('csvMatrixBtn').onclick=()=>{
  const m=loadMatrix(); const header=['Date',...m.cols.map(c=>c.label)];
  const rows=m.rows.map(r=>[r.date, ...m.cols.map(c=>r.values?.[c.id]??'')]);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([toCSV(rows,header)],{type:'text/csv'}));
  a.download=`kerr_daily_flow_matrix_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};
document.getElementById('clearMatrixBtn').onclick=()=>{ if(confirm('Clear the saved Daily Flow Matrix?')){ localStorage.removeItem(MATRIX_KEY); renderMatrix(); } };

/* ====== Title bar dynamic bits ====== */
function updateTitleBar(){
  document.getElementById('titleUpdated').textContent = `Updated — ${new Date().toLocaleString()}`;
}

/* ===== Button highlight helper ===== */
function highlightCopyNoHeader(){
  const btn=document.getElementById('copyMatrixNoHeaderBtn'); if(!btn||btn.disabled) return;
  btn.classList.add('btn-pulse'); const remove=()=>btn.classList.remove('btn-pulse');
  btn.addEventListener('click',remove,{once:true}); btn.addEventListener('blur',remove,{once:true}); setTimeout(remove,8000);
}

/* ===== bootstrap ===== */
renderMatrix();
doFetch();
</script>
</html>
