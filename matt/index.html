<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buffer ‚Üí Hazard Extent ‚Üí Parcels</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }

  /* ================= LOADER ================= */
  #loader {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center; justify-content: center;
    z-index: 9999;
  }
  #loaderBox {
    background: #fff;
    padding: 20px 26px;
    border-radius: 14px;
    min-width: 340px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    font: 14px system-ui;
  }
  #loaderTitle { font-weight: 700; margin-bottom: 6px; }
  #loaderStep { opacity: 0.85; }

  /* ================= LEGEND ================= */
  .legend {
    background: rgba(255,255,255,0.95);
    padding: 10px 12px;
    border-radius: 10px;
    font: 13px system-ui;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  .legend small {
    display: block;
    margin-top: 6px;
    opacity: 0.85;
    line-height: 1.25;
  }

  /* ================= LEFT PANEL ================= */
  .panel {
    position: absolute;
    top: 10px;
    left: 10px;
    bottom: 10px;
    width: min(520px, calc(100vw - 20px));
    background: rgba(255,255,255,0.96);
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    z-index: 1200;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: transform 220ms ease;
  }
  .panel.closed { transform: translateX(calc(-100% - 14px)); }

  .panel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .panel-title { font: 700 14px system-ui; flex: 1; }
  .panel-subtitle { font: 12px system-ui; opacity: 0.75; margin-top: 2px; }
  .panel-actions { display: flex; gap: 8px; }

  .btn {
    border: 1px solid rgba(0,0,0,0.15);
    background: #fff;
    border-radius: 10px;
    padding: 6px 10px;
    cursor: pointer;
    font: 13px system-ui;
    user-select: none;
  }
  .btn:hover { background: rgba(0,0,0,0.04); }
  .btn.primary {
    background: linear-gradient(180deg, #1f7ae0, #0e5fc4);
    color: #fff;
    border: 1px solid rgba(0,0,0,0.12);
  }
  .btn.primary:hover { filter: brightness(1.03); }

  .panel-tools {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .panel-tools input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.15);
    font: 13px system-ui;
    outline: none;
  }

  .panel-body { flex: 1; overflow: auto; }

  table { width: 100%; border-collapse: collapse; font: 12px system-ui; }
  thead th {
    position: sticky; top: 0;
    background: #f6f7f8;
    z-index: 1;
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(0,0,0,0.10);
    white-space: nowrap;
  }
  tbody td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    vertical-align: top;
  }
  tbody tr:hover { background: rgba(0,0,0,0.03); }

  .pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(0,0,0,0.06);
    font-size: 12px;
  }

  .panel-footer {
    padding: 10px 12px;
    border-top: 1px solid rgba(0,0,0,0.08);
    font: 12px system-ui;
    opacity: 0.90;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  /* Small ‚Äúopen‚Äù tab when closed */
  .open-tab {
    position: absolute;
    top: 16px;
    left: 10px;
    z-index: 1199;
    background: rgba(255,255,255,0.96);
    border-radius: 12px;
    padding: 8px 10px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.10);
    font: 13px system-ui;
    display: none;
  }
  .open-tab.show { display: inline-flex; align-items: center; gap: 8px; }

  /* Responsive: narrower table columns on small screens */
  @media (max-width: 700px) {
    .panel { width: calc(100vw - 20px); }
    thead th:nth-child(n+4),
    tbody td:nth-child(n+4) { display: none; }
  }

  /* ================= BASEMAP CONTROL STYLING ================= */
  .leaflet-control-layers {
    border-radius: 14px !important;
    box-shadow: 0 10px 28px rgba(0,0,0,0.25) !important;
    border: 1px solid rgba(0,0,0,0.10) !important;
    overflow: hidden;
  }
  .leaflet-control-layers-expanded {
    background: rgba(255,255,255,0.96) !important;
    padding: 10px 12px !important;
    font: 13px system-ui !important;
  }
  .leaflet-control-layers label { margin: 6px 0; }
  .leaflet-control-layers-separator { border-top: 1px solid rgba(0,0,0,0.08); }

  /* ================= SPLASH SCREEN ================= */
  #splash {
    position: fixed; inset: 0;
    background:
      radial-gradient(1200px 700px at 20% 15%, rgba(40,150,255,0.35), transparent 60%),
      radial-gradient(900px 600px at 80% 35%, rgba(0,255,180,0.20), transparent 55%),
      linear-gradient(180deg, rgba(10,20,35,0.65), rgba(10,20,35,0.65));
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
  }
  #splashCard {
    width: min(1100px, calc(100vw - 24px));
    max-height: min(88vh, 900px);
    overflow: auto;
    background: rgba(255,255,255,0.96);
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.50);
    border: 1px solid rgba(255,255,255,0.35);
  }
  #splashHeader {
    padding: 16px 16px 14px 16px;
    background: linear-gradient(180deg, #1f7ae0, #0e5fc4);
    color: white;
  }
  #splashHeader h2 {
    margin: 0;
    font: 800 18px system-ui;
    letter-spacing: 0.2px;
  }
  #splashHeader p {
    margin: 6px 0 0 0;
    opacity: 0.92;
    font: 13px system-ui;
    line-height: 1.35;
  }

  #splashBody { padding: 14px 16px 16px 16px; }
  .sourceGrid {
    display: grid;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap: 12px;
  }
  @media (max-width: 860px){
    .sourceGrid { grid-template-columns: 1fr; }
  }

  .sourceCard {
    border: 1px solid rgba(0,0,0,0.10);
    border-radius: 16px;
    background: white;
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    padding: 12px 12px 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .sourceTitle { font: 800 14px system-ui; margin: 0; }
  .sourceDesc { font: 12.5px system-ui; opacity: 0.85; line-height: 1.35; margin: 0; }
  .sourceUrl {
    font: 12px ui-monospace, SFMono-Regular, Menlo, monospace;
    padding: 8px 10px;
    background: rgba(0,0,0,0.04);
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
    overflow-wrap: anywhere;
  }
  .sourceActions { display: flex; gap: 10px; justify-content: flex-end; align-items: center; }

  #splashFooter {
    padding: 12px 16px 16px 16px;
    border-top: 1px solid rgba(0,0,0,0.08);
    background: rgba(0,0,0,0.02);
    font: 12px system-ui;
    opacity: 0.85;
  }
</style>
</head>

<body>
<div id="map"></div>

<!-- Splash screen -->
<div id="splash">
  <div id="splashCard">
    <div id="splashHeader">
      <h2>Choose a spatial query source</h2>
      <p>
        We‚Äôll locate you (GPS ‚Üí IP fallback), draw a 1-mile buffer, fetch hazard features within 1 mile,
        then find parcels intersecting those features.
      </p>
    </div>

    <div id="splashBody">
      <div class="sourceGrid" id="sourceGrid"></div>
    </div>

    <div id="splashFooter">
      Tip: After running once, you can <b>Alt+Click</b> anywhere to run there, or <b>Alt+L</b> to rerun the last location.
    </div>
  </div>
</div>

<!-- Left panel -->
<div id="panel" class="panel">
  <div class="panel-header">
    <div style="min-width:0;">
      <div class="panel-title">Selected Parcels</div>
      <div class="panel-subtitle" id="panelSubtitle">No results yet</div>
    </div>
    <div class="panel-actions">
      <button class="btn" id="btnSource">Source</button>
      <button class="btn" id="btnExport">Export CSV</button>
      <button class="btn" id="btnClose">Close</button>
    </div>
  </div>

  <div class="panel-tools">
    <input id="searchBox" type="text" placeholder="Filter parcels (owner, address, PROP_ID, GEO_ID, ZIP)‚Ä¶" />
  </div>

  <div class="panel-body">
    <table id="parcelTable">
      <thead>
        <tr>
          <th>OBJECTID</th>
          <th>OWNER_NAME</th>
          <th>SITUS_ADDR</th>
          <th>PROP_ID</th>
          <th>GEO_ID</th>
          <th>MKT_VALUE</th>
          <th>SITUS_CITY</th>
          <th>SITUS_ZIP</th>
        </tr>
      </thead>
      <tbody id="parcelTbody">
        <tr><td colspan="8" style="padding:14px 10px; opacity:.75;">Run a query to populate this table.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="panel-footer">
    <span class="pill" id="pillCount">0 parcels</span>
    <span class="pill" id="pillForecast">0 hazard feats</span>
    <span class="pill" id="pillSource">Source: ‚Äî</span>
    <span class="pill">Alt+Click = run here</span>
    <span class="pill">Alt+L = rerun last</span>
  </div>
</div>

<div id="openTab" class="open-tab">üìÑ Parcels</div>

<!-- Loader -->
<div id="loader">
  <div id="loaderBox">
    <div id="loaderTitle">Processing</div>
    <div id="loaderStep">Starting‚Ä¶</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ======================================================
   CONFIG
====================================================== */
const ONE_MILE_METERS = 1609.344;

// Texas parcels (TNRIS)
const PARCELS_URL = "https://feature.tnris.org/arcgis/rest/services/Parcels/stratmap19_land_parcels_48/MapServer/0";

// NFHL (Flood Hazard Areas) - you were using layer 28 directly
const NFHL_LAYER_URL = "https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer/28";
const NFHL_WHERE = "FLD_ZONE IN ('A','AE')";

// NOAA services user requested
const NOAA_5DAY_MAX_INUNDATION_LAYER_URL =
  "https://maps.water.noaa.gov/server/rest/services/nwm/mrf_gfs_5day_max_inundation_extent/MapServer/0";

// NWM ANA Inundation Extent (EXPERIMENTAL) FeatureServer
const NWM_ANA_INUNDATION_LAYER_URL =
  "https://maps.water.noaa.gov/server/rest/services/nwm/ana_inundation_extent/FeatureServer/0";

// NWM AEP FeatureServer layer 2
const NWM_AEP_LAYER_URL =
  "https://maps.water.noaa.gov/server/rest/services/nwm/ana_inundation_extent/FeatureServer/2";

// Splash query sources (4 options)
const SOURCES = [
  {
    id: "nfhl",
    title: "Query the NFHL (Current Effective)",
    desc: "FEMA NFHL Flood Hazard Areas filtered to A/AE. Best for regulatory flood zone context.",
    layerUrl: NFHL_LAYER_URL,
    where: NFHL_WHERE
  },
  {
    id: "noaa5",
    title: "Query the 5-Day Max Inundation Extent",
    desc: "NOAA/NWS NWM maximum forecast inundation extent over the next 5 days (service-specific).",
    layerUrl: NOAA_5DAY_MAX_INUNDATION_LAYER_URL,
    where: "1=1"
  },
  {
    id: "ana0",
    title: "Query ANA Inundation Extent (EXPERIMENTAL)",
    desc: "Experimental inundation extent derived from NWM analysis/assimilation. Updated hourly.",
    layerUrl: NWM_ANA_INUNDATION_LAYER_URL,
    where: "1=1"
  },
  {
    id: "aep2",
    title: "Query Estimated Annual Exceedance Probability (AEP)",
    desc: "Shows magnitude/probability context (AEP). Not a regulatory floodplain; probability-based.",
    layerUrl: NWM_AEP_LAYER_URL,
    where: "1=1"
  }
];

// Active source (set by splash selection)
let activeSource = null;

/* ======================================================
   MAP + BASEMAPS (no Stadia/Stamen provider strings)
====================================================== */
const map = L.map("map", { zoomControl: false }).setView([31, -99], 6);
L.control.zoom({ position: "topright" }).addTo(map);

// Basemaps (lots of options, all public/free)
const bmEsriImagery = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmEsriStreets = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmEsriTopo = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmEsriLightGray = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmEsriDarkGray = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmEsriNatGeo = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri" }
);
const bmOSM = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { attribution: "¬© OpenStreetMap contributors", maxZoom: 19 }
);
const bmCartoPositron = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  { attribution: "¬© OpenStreetMap ¬© CARTO", maxZoom: 20 }
);
const bmCartoDark = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { attribution: "¬© OpenStreetMap ¬© CARTO", maxZoom: 20 }
);
const bmOpenTopo = L.tileLayer(
  "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
  { attribution: "¬© OpenStreetMap contributors, ¬© OpenTopoMap", maxZoom: 17 }
);
const bmUSGSTopo = L.tileLayer(
  "https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}",
  { attribution: "USGS The National Map", maxZoom: 20 }
);
const bmUSGSImagery = L.tileLayer(
  "https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}",
  { attribution: "USGS The National Map", maxZoom: 20 }
);

// Default basemap
bmEsriImagery.addTo(map);

/* ======================================================
   LOADER
====================================================== */
const loader = document.getElementById("loader");
const loaderStep = document.getElementById("loaderStep");
function showLoader(msg){ loader.style.display="flex"; loaderStep.textContent=msg; }
function stepLoader(msg){ loaderStep.textContent=msg; }
function hideLoader(){ loader.style.display="none"; }

/* ======================================================
   LEFT PANEL UI
====================================================== */
const panel = document.getElementById("panel");
const openTab = document.getElementById("openTab");
const btnClose = document.getElementById("btnClose");
const btnExport = document.getElementById("btnExport");
const btnSource = document.getElementById("btnSource");
const searchBox = document.getElementById("searchBox");
const tbody = document.getElementById("parcelTbody");
const panelSubtitle = document.getElementById("panelSubtitle");
const pillCount = document.getElementById("pillCount");
const pillForecast = document.getElementById("pillForecast");
const pillSource = document.getElementById("pillSource");

btnClose.addEventListener("click", () => {
  panel.classList.add("closed");
  openTab.classList.add("show");
});
openTab.addEventListener("click", () => {
  panel.classList.remove("closed");
  openTab.classList.remove("show");
});

// Open splash again any time
btnSource.addEventListener("click", () => {
  showSplash();
});

// Prevent map drag when interacting with panel
L.DomEvent.disableClickPropagation(panel);
L.DomEvent.disableScrollPropagation(panel);

/* ======================================================
   RESULT LAYERS
====================================================== */
const bufferLayer = L.featureGroup().addTo(map);

const hazardLayer = L.geoJSON(null, {
  style: {
    color: "#0078ff",
    weight: 2,
    opacity: 1,
    fillColor: "#00ccff",
    fillOpacity: 0.35
  }
}).addTo(map);

const parcelsLayer = L.geoJSON(null, {
  style: {
    color: "red",
    weight: 2,
    opacity: 1,
    fillColor: "red",
    fillOpacity: 0.5
  }
}).addTo(map);

const heatLayer = L.heatLayer([], { radius: 28, blur: 20 }).addTo(map);

/* ======================================================
   BASEMAP + OVERLAY CONTROL (nice widget)
====================================================== */
const baseLayers = {
  "Esri Imagery": bmEsriImagery,
  "Esri Streets": bmEsriStreets,
  "Esri Topo": bmEsriTopo,
  "Esri Light Gray": bmEsriLightGray,
  "Esri Dark Gray": bmEsriDarkGray,
  "Esri NatGeo": bmEsriNatGeo,
  "OpenStreetMap": bmOSM,
  "CARTO Positron": bmCartoPositron,
  "CARTO DarkMatter": bmCartoDark,
  "OpenTopoMap": bmOpenTopo,
  "USGS Topo": bmUSGSTopo,
  "USGS Imagery": bmUSGSImagery
};

const overlays = {
  "Buffer (1 mile)": bufferLayer,
  "Hazard extent": hazardLayer,
  "Selected parcels": parcelsLayer,
  "Parcel heatmap": heatLayer
};

// Put it top-right under zoom; collapsed so it‚Äôs a tidy widget
L.control.layers(baseLayers, overlays, { position: "topright", collapsed: true }).addTo(map);

/* ======================================================
   LEGEND
====================================================== */
let fcEl, pcEl, srcEl;
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Results</b><br>
    Hazard features: <strong id="fc">‚Äî</strong><br>
    Parcels intersecting: <strong id="pc">‚Äî</strong>
    <small id="srcLine">Source: ‚Äî<br>üìç = locate ‚Ä¢ Alt+Click = run here ‚Ä¢ Alt+L = rerun last</small>
  `;
  fcEl = div.querySelector("#fc");
  pcEl = div.querySelector("#pc");
  srcEl = div.querySelector("#srcLine");
  return div;
};
legend.addTo(map);

function setCounts(fc, pc){
  fcEl.textContent = fc;
  pcEl.textContent = pc;
  pillForecast.textContent = `${fc} hazard feats`;
  pillCount.textContent = `${pc} parcels`;
}

function setSourceLabel(){
  const name = activeSource ? activeSource.title : "‚Äî";
  pillSource.textContent = `Source: ${name}`;
  if (srcEl) srcEl.innerHTML = `Source: ${name}<br>üìç = locate ‚Ä¢ Alt+Click = run here ‚Ä¢ Alt+L = rerun last`;
}

/* ======================================================
   HELPERS
====================================================== */
let currentParcels = [];
let currentHazardCount = 0;

function clearAll(){
  bufferLayer.clearLayers();
  hazardLayer.clearLayers();
  parcelsLayer.clearLayers();
  heatLayer.setLatLngs([]);
  setCounts("‚Äî","‚Äî");

  currentParcels = [];
  currentHazardCount = 0;
  renderParcelTable([]);
  panelSubtitle.textContent = "No results yet";
}

function centroid(feature){
  const b = L.geoJSON(feature).getBounds();
  return b.isValid() ? b.getCenter() : null;
}

function buildMultiPolygon(features){
  const coords = [];
  for (const f of features){
    const g = f.geometry;
    if (!g) continue;

    if (g.type === "Polygon") coords.push(g.coordinates);
    else if (g.type === "MultiPolygon") {
      for (const poly of g.coordinates) coords.push(poly);
    }
  }
  return { type:"Feature", geometry:{ type:"MultiPolygon", coordinates: coords } };
}

function safeStr(v){
  if (v === null || v === undefined) return "";
  return String(v);
}

function money(v){
  const n = Number(v);
  if (!isFinite(n)) return "";
  return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
}

/* ======================================================
   TABLE
====================================================== */
const PARCEL_FIELDS = [
  "objectid","prop_id","geo_id","owner_name","name_care","legal_area","lgl_area_u",
  "gis_area","gis_area_u","legal_desc","stat_land_","loc_land_u","land_value","imp_value",
  "mkt_value","situs_addr","situs_num","situs_stre","situs_st_1","situs_st_2",
  "situs_city","situs_stat","situs_zip"
];

function normalizeAttrs(attrs){
  const out = {};
  for (const k in attrs){ out[k.toLowerCase()] = attrs[k]; }
  return out;
}

function renderParcelTable(parcelFeatures, filterText=""){
  const ft = filterText.trim().toLowerCase();

  const rows = [];
  for (const f of parcelFeatures){
    const a = normalizeAttrs(f.properties || f.attributes || {});
    rows.push(a);
  }

  const filtered = ft ? rows.filter(r => {
    const hay =
      safeStr(r.owner_name) + " " +
      safeStr(r.situs_addr) + " " +
      safeStr(r.situs_city) + " " +
      safeStr(r.situs_zip) + " " +
      safeStr(r.prop_id) + " " +
      safeStr(r.geo_id);
    return hay.toLowerCase().includes(ft);
  }) : rows;

  panelSubtitle.textContent = `${filtered.length} shown ‚Ä¢ ${rows.length} total`;

  tbody.innerHTML = "";
  if (!filtered.length){
    tbody.innerHTML = `<tr><td colspan="8" style="padding:14px 10px; opacity:.75;">No parcels match your filter.</td></tr>`;
    return;
  }

  for (const r of filtered){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${safeStr(r.objectid)}</td>
      <td>${safeStr(r.owner_name)}</td>
      <td>${safeStr(r.situs_addr)}</td>
      <td>${safeStr(r.prop_id)}</td>
      <td>${safeStr(r.geo_id)}</td>
      <td>${money(r.mkt_value)}</td>
      <td>${safeStr(r.situs_city)}</td>
      <td>${safeStr(r.situs_zip)}</td>
    `;
    tbody.appendChild(tr);
  }
}

searchBox.addEventListener("input", () => {
  renderParcelTable(currentParcels, searchBox.value);
});

btnExport.addEventListener("click", () => {
  if (!currentParcels.length){
    alert("No parcels to export yet.");
    return;
  }

  const header = PARCEL_FIELDS.join(",");
  const lines = [header];

  for (const f of currentParcels){
    const a = normalizeAttrs(f.properties || f.attributes || {});
    const row = PARCEL_FIELDS.map(fn => {
      const val = a[fn];
      const s = safeStr(val).replace(/"/g, '""');
      return `"${s}"`;
    }).join(",");
    lines.push(row);
  }

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "selected_parcels.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ======================================================
   SPLASH SCREEN LOGIC (4 options)
====================================================== */
const splash = document.getElementById("splash");
const sourceGrid = document.getElementById("sourceGrid");

function showSplash(){
  // close panel so splash feels cleaner
  panel.classList.add("closed");
  openTab.classList.add("show");

  sourceGrid.innerHTML = "";
  for (const s of SOURCES){
    const card = document.createElement("div");
    card.className = "sourceCard";
    card.innerHTML = `
      <div>
        <p class="sourceTitle">${s.title}</p>
        <p class="sourceDesc">${s.desc}</p>
      </div>
      <div class="sourceUrl">${s.layerUrl}</div>
      <div class="sourceActions">
        <button class="btn primary" data-source="${s.id}">Select & Run</button>
      </div>
    `;
    sourceGrid.appendChild(card);
  }

  splash.style.display = "flex";

  splash.querySelectorAll("button[data-source]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-source");
      activeSource = SOURCES.find(x => x.id === id) || null;
      setSourceLabel();
      splash.style.display = "none";
      smartLocate(); // start only after selection
    });
  });
}

/* ======================================================
   WORKFLOW
   Buffer ‚Üí Hazard (nearby) ‚Üí Parcels ‚à© Hazard ‚Üí Heatmap + Table
====================================================== */
let workflowInFlight = false;
let lastAltClickLatLng = null;

function runWorkflow(lat, lng, { zoomToBuffer = true } = {}){
  if (!activeSource){
    showSplash();
    return;
  }
  if (workflowInFlight) return;
  workflowInFlight = true;

  showLoader("Creating 1-mile buffer‚Ä¶");
  clearAll();

  const buffer = L.circle([lat, lng], {
    radius: ONE_MILE_METERS,
    color: "yellow",
    fillOpacity: 0.10
  }).addTo(bufferLayer);

  if (zoomToBuffer) map.fitBounds(buffer.getBounds());

  stepLoader("Querying hazard features (within 1 mile)‚Ä¶");

  // Step 1: Hazard features from selected service near the point
  L.esri.query({ url: activeSource.layerUrl })
    .where(activeSource.where || "1=1")
    .nearby(L.latLng(lat, lng), ONE_MILE_METERS)
    .limit(2000) // NOAA services may have more; MaxRecordCount applies server-side
    .run((hErr, hazardFC) => {
      if (hErr){
        console.error("Hazard query error:", hErr);
        hideLoader();
        workflowInFlight = false;
        alert("Hazard query failed. Check the console for details.");
        return;
      }

      const hazardFeats = hazardFC?.features || [];
      currentHazardCount = hazardFeats.length;
      setCounts(currentHazardCount, "‚Äî");

      if (!hazardFeats.length){
        hideLoader();
        workflowInFlight = false;
        alert("No hazard features found within 1 mile.");
        return;
      }

      hazardLayer.addData(hazardFeats);

      stepLoader("Querying parcels intersecting hazard‚Ä¶");

      // Step 2: Parcels that intersect hazard geometry
      const hazardMultiPoly = buildMultiPolygon(hazardFeats);

      // NOTE: If the hazard layer returns LINE features only, MultiPolygon will be empty.
      // In that case, fall back to a broad parcel query in 1 mile and intersect client-side.
      const hasPoly = (hazardMultiPoly?.geometry?.coordinates || []).length > 0;

      if (hasPoly){
        L.esri.query({ url: PARCELS_URL })
          .intersects(hazardMultiPoly)
          .limit(5000)
          .run((pErr, parcelFC) => finishParcels(lat, lng, pErr, parcelFC));
      } else {
        // Fallback: get parcels near point, then intersect in browser with bounds check
        L.esri.query({ url: PARCELS_URL })
          .nearby(L.latLng(lat, lng), ONE_MILE_METERS)
          .limit(5000)
          .run((pErr, parcelFC) => finishParcels(lat, lng, pErr, parcelFC));
      }
    });
}

function finishParcels(lat, lng, pErr, parcelFC){
  if (pErr){
    console.error("Parcel query error:", pErr);
    hideLoader();
    workflowInFlight = false;
    alert("Parcel query failed.");
    return;
  }

  const parcels = parcelFC?.features || [];
  currentParcels = parcels;

  setCounts(currentHazardCount, parcels.length);
  parcelsLayer.addData(parcels);

  stepLoader("Building heatmap and table‚Ä¶");

  const heatPts = [];
  for (const p of parcels){
    const c = centroid(p);
    if (c) heatPts.push([c.lat, c.lng, 1]);
  }
  heatLayer.setLatLngs(heatPts);

  renderParcelTable(currentParcels, searchBox.value);

  hideLoader();
  workflowInFlight = false;

  // Open panel automatically
  panel.classList.remove("closed");
  openTab.classList.remove("show");

  L.popup()
    .setLatLng([lat, lng])
    .setContent(`
      <b>Complete</b><br>
      Hazard features: ${currentHazardCount}<br>
      Parcels intersecting: ${parcels.length}
    `)
    .openOn(map);
}

/* ======================================================
   LOCATION (GPS ‚Üí IP fallback)
====================================================== */
function locateByIP(){
  stepLoader("GPS blocked ‚Äî using IP location‚Ä¶");
  fetch("https://ipapi.co/json/")
    .then(r => r.json())
    .then(d => {
      if (!d || !d.latitude) throw new Error();
      runWorkflow(d.latitude, d.longitude);
    })
    .catch(() => {
      hideLoader();
      workflowInFlight = false;
      alert("Location failed.");
    });
}

function smartLocate(){
  showLoader("Locating‚Ä¶");

  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos => runWorkflow(pos.coords.latitude, pos.coords.longitude),
      () => locateByIP(),
      { enableHighAccuracy: true, timeout: 7000 }
    );
  } else {
    locateByIP();
  }
}

/* ======================================================
   CONTROLS
====================================================== */
const locateBtn = L.control({ position: "topleft" });
locateBtn.onAdd = function () {
  const div = L.DomUtil.create("div", "leaflet-bar leaflet-control");
  div.innerHTML = `<a href="#" title="Locate" style="font-size:20px;padding:4px;">üìç</a>`;
  div.onclick = e => { e.preventDefault(); smartLocate(); };
  return div;
};
locateBtn.addTo(map);

/* ======================================================
   ALT INTERACTIONS
====================================================== */
map.on("click", e => {
  if (e.originalEvent?.altKey){
    lastAltClickLatLng = e.latlng;
    runWorkflow(e.latlng.lat, e.latlng.lng);
  }
});

window.addEventListener("keydown", e => {
  if (!e.altKey) return;
  if ((e.key || "").toLowerCase() !== "l") return;

  e.preventDefault();

  if (!lastAltClickLatLng){
    alert("Alt+L: Alt+Click somewhere on the map first.");
    return;
  }

  clearAll();
  runWorkflow(lastAltClickLatLng.lat, lastAltClickLatLng.lng);
});

/* ======================================================
   START
====================================================== */
setSourceLabel();
showSplash(); // require choosing a source first
</script>
</body>
</html>
